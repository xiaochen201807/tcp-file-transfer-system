name: Build Native Binaries

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  release:
    types: [ created ]
  workflow_dispatch:
    inputs:
      force_build:
        description: 'Force full build (ignore change detection)'
        required: false
        default: false
        type: boolean

env:
  MAVEN_OPTS: "-Xmx2g -XX:+UseG1GC"
  NATIVE_IMAGE_OPTS: "--no-fallback --enable-http --enable-https"

jobs:
  check-changes:
    runs-on: ubuntu-latest
    outputs:
      java-changed: ${{ steps.changes.outputs.java }}
      config-changed: ${{ steps.changes.outputs.config }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Check for changes
      id: changes
      uses: dorny/paths-filter@v2
      with:
        filters: |
          java:
            - 'tcp-server/src/**'
            - 'tcp-client/src/**'
            - '**/pom.xml'
          config:
            - '**/*.json'
            - '**/*.yml'
            - '**/*.yaml'

  compile:
    runs-on: ubuntu-latest
    needs: check-changes
    if: needs.check-changes.outputs.java-changed == 'true' || github.event.inputs.force_build == 'true'
    outputs:
      cache-key: ${{ steps.cache-key.outputs.key }}
      version: ${{ steps.version.outputs.version }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Install GraalVM Native Image
      uses: graalvm/setup-graalvm@v1
      with:
        java-version: '17'
        distribution: 'graalvm'
        components: 'native-image'

    - name: Generate version
      id: version
      run: |
        if [[ "${{ github.event_name }}" == "release" ]]; then
          echo "version=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
        else
          echo "version=dev-${{ github.sha }}" >> $GITHUB_OUTPUT
        fi

    - name: Generate cache key
      id: cache-key
      run: |
        echo "key=${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}" >> $GITHUB_OUTPUT

    - name: Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ steps.cache-key.outputs.key }}
        restore-keys: ${{ runner.os }}-m2

    - name: Cache GraalVM build cache
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/graalvm/
          ~/.gradle/caches/
        key: ${{ runner.os }}-graalvm-${{ hashFiles('**/pom.xml') }}
        restore-keys: |
          ${{ runner.os }}-graalvm-
          ${{ runner.os }}-

    - name: Compile Server
      run: |
        cd tcp-server
        mvn clean compile -DskipTests -Dversion=${{ steps.version.outputs.version }}

    - name: Compile Client
      run: |
        cd tcp-client
        mvn clean compile -DskipTests -Dversion=${{ steps.version.outputs.version }}

    - name: Upload compiled classes
      uses: actions/upload-artifact@v4
      with:
        name: compiled-classes
        path: |
          tcp-server/target/classes/
          tcp-client/target/classes/
        retention-days: 1

  test:
    runs-on: ubuntu-latest
    needs: [check-changes, compile]
    if: needs.check-changes.outputs.java-changed == 'true' || github.event.inputs.force_build == 'true'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'graalvm'
        java-version: '17.0.9'

    - name: Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ needs.compile.outputs.cache-key }}
        restore-keys: ${{ runner.os }}-m2

    - name: Download compiled classes
      uses: actions/download-artifact@v4
      with:
        name: compiled-classes
        path: .

    - name: Restore target directories
      shell: bash
      run: |
        # 检查下载的artifact结构
        ls -la
        echo "=== tcp-server structure ==="
        ls -la tcp-server/ || echo "tcp-server not found"
        echo "=== tcp-client structure ==="
        ls -la tcp-client/ || echo "tcp-client not found"
        
        # 确保target目录存在
        mkdir -p tcp-server/target
        mkdir -p tcp-client/target
        
        # 如果classes目录在target下，直接使用
        # 如果classes目录在根目录下，移动到target
        if [ -d "tcp-server/target/classes" ]; then
          echo "Classes already in correct location"
        elif [ -d "tcp-server/classes" ]; then
          mv tcp-server/classes tcp-server/target/
        fi
        
        if [ -d "tcp-client/target/classes" ]; then
          echo "Classes already in correct location"
        elif [ -d "tcp-client/classes" ]; then
          mv tcp-client/classes tcp-client/target/
        fi

    - name: Verify compilation
      shell: bash
      run: |
        echo "Verifying server compilation..."
        ls -la tcp-server/target/classes/
        echo "Verifying client compilation..."
        ls -la tcp-client/target/classes/

  build-native:
    needs: [check-changes, compile, test]
    if: needs.check-changes.outputs.java-changed == 'true' || github.event.inputs.force_build == 'true'
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: windows-latest
            platform: windows
            arch: x64
            extension: .exe
            graalvm-arch: amd64
          - os: ubuntu-latest
            platform: linux
            arch: x64
            extension: ""
            graalvm-arch: amd64
          - os: ubuntu-latest
            platform: linux
            arch: arm64
            extension: ""
            graalvm-arch: aarch64
          - os: macos-latest
            platform: macos
            arch: x64
            extension: ""
            graalvm-arch: amd64
          - os: macos-latest
            platform: macos
            arch: arm64
            extension: ""
            graalvm-arch: aarch64

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Install GraalVM Native Image
      uses: graalvm/setup-graalvm@v1
      with:
        java-version: '17'
        distribution: 'graalvm'
        components: 'native-image'

    - name: Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ needs.compile.outputs.cache-key }}
        restore-keys: ${{ runner.os }}-m2

    - name: Cache GraalVM build cache
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/graalvm/
          ~/.gradle/caches/
        key: ${{ runner.os }}-graalvm-${{ hashFiles('**/pom.xml') }}
        restore-keys: |
          ${{ runner.os }}-graalvm-
          ${{ runner.os }}-

    - name: Download compiled classes
      uses: actions/download-artifact@v4
      with:
        name: compiled-classes
        path: .

    - name: Restore target directories
      shell: bash
      run: |
        # 检查下载的artifact结构
        ls -la
        echo "=== tcp-server structure ==="
        ls -la tcp-server/ || echo "tcp-server not found"
        echo "=== tcp-client structure ==="
        ls -la tcp-client/ || echo "tcp-client not found"
        
        # 确保target目录存在
        mkdir -p tcp-server/target
        mkdir -p tcp-client/target
        
        # 如果classes目录在target下，直接使用
        # 如果classes目录在根目录下，移动到target
        if [ -d "tcp-server/target/classes" ]; then
          echo "Classes already in correct location"
        elif [ -d "tcp-server/classes" ]; then
          mv tcp-server/classes tcp-server/target/
        fi
        
        if [ -d "tcp-client/target/classes" ]; then
          echo "Classes already in correct location"
        elif [ -d "tcp-client/classes" ]; then
          mv tcp-client/classes tcp-client/target/
        fi

    - name: Build Server Native
      run: |
        cd tcp-server
        mvn package -Pnative -DskipTests "-Dmaven.compiler.skip=true" "-Dversion=${{ needs.compile.outputs.version }}"

    - name: Build Client Native
      run: |
        cd tcp-client
        mvn package -Pnative -DskipTests "-Dmaven.compiler.skip=true" "-Dversion=${{ needs.compile.outputs.version }}"

    - name: Copy external configs
      shell: bash
      run: |
        if [ -f "response-config-external.json" ]; then
          cp response-config-external.json tcp-server/target/response-config.json
        fi
        if [ -f "client-config-external.json" ]; then
          cp client-config-external.json tcp-client/target/client-config.json
        fi

    - name: Create release directory
      shell: bash
      run: |
        mkdir -p release/${{ matrix.platform }}-${{ matrix.arch }}

    - name: Copy binaries
      shell: bash
      run: |
        cp tcp-server/target/tcp-server-native${{ matrix.extension }} release/${{ matrix.platform }}-${{ matrix.arch }}/tcp-server-native${{ matrix.extension }}
        cp tcp-client/target/tcp-client-native${{ matrix.extension }} release/${{ matrix.platform }}-${{ matrix.arch }}/tcp-client-native${{ matrix.extension }}
        
        # Copy configs
        cp tcp-server/target/response-config.json release/${{ matrix.platform }}-${{ matrix.arch }}/ 2>/dev/null || true
        cp tcp-client/target/client-config.json release/${{ matrix.platform }}-${{ matrix.arch }}/ 2>/dev/null || true

    - name: Optimize binaries
      shell: bash
      run: |
        # 生成校验和
        cd release/${{ matrix.platform }}-${{ matrix.arch }}
        sha256sum tcp-server-native${{ matrix.extension }} > checksums.txt
        sha256sum tcp-client-native${{ matrix.extension }} >> checksums.txt
        
        # 使用UPX压缩（如果可用）
        if command -v upx &> /dev/null; then
          upx --best tcp-server-native${{ matrix.extension }}
          upx --best tcp-client-native${{ matrix.extension }}
        fi

    - name: Create startup scripts
      shell: bash
      run: |
        if [ "${{ matrix.platform }}" = "windows" ]; then
          cat > release/${{ matrix.platform }}-${{ matrix.arch }}/start-server.bat << 'EOF'
        @echo off
        chcp 65001 >nul
        echo 🚀 启动TCP服务端...
        echo 版本: ${{ needs.compile.outputs.version }}
        tcp-server-native.exe
        pause
        EOF
        
          cat > release/${{ matrix.platform }}-${{ matrix.arch }}/start-client.bat << 'EOF'
        @echo off
        chcp 65001 >nul
        echo 🚀 启动TCP客户端...
        echo 版本: ${{ needs.compile.outputs.version }}
        tcp-client-native.exe
        pause
        EOF
        else
          cat > release/${{ matrix.platform }}-${{ matrix.arch }}/start-server.sh << 'EOF'
        #!/bin/bash
        echo "🚀 启动TCP服务端..."
        echo "版本: ${{ needs.compile.outputs.version }}"
        ./tcp-server-native
        EOF
        
          cat > release/${{ matrix.platform }}-${{ matrix.arch }}/start-client.sh << 'EOF'
        #!/bin/bash
        echo "🚀 启动TCP客户端..."
        echo "版本: ${{ needs.compile.outputs.version }}"
        ./tcp-client-native
        EOF
        
          chmod +x release/${{ matrix.platform }}-${{ matrix.arch }}/*.sh
        fi

    - name: Create README
      shell: bash
      run: |
        cat > release/${{ matrix.platform }}-${{ matrix.arch }}/README.md << EOF
        # TCP Demo Native Binaries
        
        ## 平台信息
        - 平台: ${{ matrix.platform }}
        - 架构: ${{ matrix.arch }}
        - 版本: ${{ needs.compile.outputs.version }}
        - 构建时间: $(date)
        
        ## 文件说明
        - `tcp-server-native${{ matrix.extension }}`: TCP服务端
        - `tcp-client-native${{ matrix.extension }}`: TCP客户端
        - `checksums.txt`: 文件校验和
        - `start-*.bat/sh`: 启动脚本
        
        ## 使用方法
        ${{ matrix.platform == 'windows' && '运行 start-server.bat 启动服务端，运行 start-client.bat 启动客户端' || '运行 ./start-server.sh 启动服务端，运行 ./start-client.sh 启动客户端' }}
        
        ## 访问地址
        - 服务端管理: http://localhost:8080/admin/status
        - 客户端界面: http://localhost:8081
        EOF

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: native-binaries-${{ matrix.platform }}-${{ matrix.arch }}
        path: release/${{ matrix.platform }}-${{ matrix.arch }}/
        retention-days: 30

  create-release:
    needs: [check-changes, build-native]
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts/

    - name: Create release archive
      shell: bash
      run: |
        mkdir -p release
        for dir in artifacts/native-binaries-*/;
          platform=$(basename "$dir")
          cp -r "$dir" "release/$platform"
        done
        
        # Create zip files for each platform
        cd release
        for dir in */; do
          platform=$(basename "$dir")
          zip -r "${platform}.zip" "$platform"
        done

    - name: Upload release assets
      uses: softprops/action-gh-release@v1
      with:
        files: release/*.zip
        tag_name: ${{ github.event.release.tag_name }}
        name: Native Binaries ${{ github.event.release.tag_name }}
        body: |
          ## 🚀 Native Binaries Release
          
          ### 📦 包含的平台
          - Windows x64
          - Linux x64  
          - Linux ARM64
          - macOS x64
          - macOS ARM64
          
          ### 🔧 使用方法
          1. 下载对应平台的zip文件
          2. 解压到本地目录
          3. 运行启动脚本
          
          ### 🌐 访问地址
          - 服务端管理: http://localhost:8080/admin/status
          - 客户端界面: http://localhost:8081
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify:
    needs: [check-changes, build-native, create-release]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Notify on success
      if: needs.build-native.result == 'success'
      run: |
        echo "✅ Native binaries built successfully!"
        echo "Platforms: Windows x64, Linux x64, Linux ARM64, macOS x64, macOS ARM64"
        echo "Version: ${{ needs.compile.outputs.version }}"

    - name: Notify on failure
      if: needs.build-native.result == 'failure'
      run: |
        echo "❌ Native binary build failed!"
        echo "Please check the build logs for details."